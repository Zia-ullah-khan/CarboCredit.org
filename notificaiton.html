<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Notification Data</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }
        .notifications-bell {
            position: relative;
            display: inline-block;
            margin-right: 20px;
            cursor: pointer;
        }
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 5px 8px;
            font-size: 12px;
        }
        img{
            width: 15px;
            height: 15px;
        }
    </style>
</head>
<body>
    <div id="notificationData"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetchData();
        });
        let matchResult = "";
        let message ="";
        var name = "";
        var username = "";
        var publicKeyObject = "";
        function fetchData() {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/includes/noti_system.inc.php", true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            username = localStorage.getItem("username");

            var requestData = "username=" + localStorage.getItem("username");

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        console.log("Server response:", xhr.responseText);
                        try {
                            var data = JSON.parse(xhr.responseText.trim());
                            console.log("Parsed data:", data);
                            renderTable(data);
                        } catch (error) {
                            console.error("Error parsing JSON:", error);
                        }
                    } else {
                        console.error("Error:", xhr.status, xhr.statusText);
                    }
                }
            };

            xhr.send(requestData);
        }

        function renderTable(data) {
            let html = "<table><tr><th>ID</th><th>Message</th><th></th><th>Status</th></tr>";

            data.forEach(row => {
                if (row.id) {

            message = row.noti_data;
                    
                    // Use a regular expression to extract the part after "from your"
                    html += `<tr>
                                <td>${row.id}</td>
                                <td>${row.noti_data}</td>
                                <td><button data-id="${row.id}">Continue with deal</button></td>
                                <td id="status-${row.id}">${row.noti_status}</td>
                             </tr>`;
                }
            });

            html += "</table>";
            document.getElementById('notificationData').innerHTML = html;

            addEventListeners();
        }

        function addEventListeners() {
            var buttons = document.querySelectorAll('button');
            buttons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var notificationId = this.getAttribute('data-id');
                    let matchResult = message.match(/from your (.*)/i)[1];
                    updateNotificationStatus(notificationId);
                    getuser(matchResult);
                    setTimeout(function() {
                        getPownerkey(name);
                        console.log(name);
                        getamount(name, username, matchResult)
                    }, 2000);

                });
            });
        }

        function updateNotificationStatus(notificationId) {
            var updateStatusXHR = new XMLHttpRequest();
            updateStatusXHR.open("POST", "/includes/update_status.inc.php", true);
            updateStatusXHR.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            var updateData = "notificationId=" + notificationId + "&status=inactive";
            console.log(updateData)

            updateStatusXHR.onreadystatechange = function () {
                if (updateStatusXHR.readyState === 4) {
                    if (updateStatusXHR.status === 200) {
                        console.log("Notification status updated successfully:", updateStatusXHR.responseText);
                    } else {
                        console.error("Error updating notification status:", updateStatusXHR.status, updateStatusXHR.statusText);
                    }
                }
            };

            updateStatusXHR.send(updateData);
        }

        function getuser(project) {
            var updateStatusXHR = new XMLHttpRequest();
            updateStatusXHR.open("POST", "/includes/get-username.inc.php", true);
            updateStatusXHR.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            
            matchResult = message.match(/from your (.*)/i)[1];
            console.log(matchResult);
            var updateData = "project=" + matchResult;
            console.log(updateData)
            

            updateStatusXHR.onreadystatechange = function () {
                if (updateStatusXHR.readyState === 4) {
                    if (updateStatusXHR.status === 200) {
                        console.log("username is :", updateStatusXHR.responseText);
// Your input string
var jsonString = updateStatusXHR.responseText;

// Parse the JSON string into a JavaScript object
var jsonObject = JSON.parse(jsonString);

// Access the value of the "username" property
name = jsonObject.username;
localStorage.setItem("name", name);
// Output the result
console.log(name);  // This will output: Zia_Test_Login_Username

                    } else {
                        console.error("unable to get username:", updateStatusXHR.status, updateStatusXHR.statusText);
                    }
                }
            };

            updateStatusXHR.send(updateData);
        }

        function getPownerkey(username) {
            var updateStatusXHR = new XMLHttpRequest();
            updateStatusXHR.open("POST", "/includes/get-user-Pkey.inc.php", true);
            updateStatusXHR.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            var updateData = "name=" + name;
            console.log(updateData)
            

    updateStatusXHR.onreadystatechange = function () {
        if (updateStatusXHR.readyState === 4) {
            if (updateStatusXHR.status === 200) {
                console.log("Public Key response:", updateStatusXHR.responseText);

                // Parse the JSON string into a JavaScript object
                var jsonObject = JSON.parse(updateStatusXHR.responseText);

                console.log(jsonObject)

                // Access the value of the "public_key" property
                publicKeyObject = jsonObject.public_key;

                console.log("Parsed Public Key:", publicKeyObject);

                // Redirect to payment.html with the public key in the URL
                //window.location.href = "payment.html?publicKey=" + encodeURIComponent(publicKeyObject);
            } else {
                console.error("Unable to get public key:", updateStatusXHR.status, updateStatusXHR.statusText);
            }
        }
    };

            updateStatusXHR.send(updateData);
        }
        function getamount(purcharser, to, project) {
            var updateStatusXHR = new XMLHttpRequest();
            updateStatusXHR.open("POST", "/includes/get-amount.inc.php", true);
            updateStatusXHR.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            var updateData = "purcharser=" + purcharser + "&to=" + to + "&project=" + project;
            console.log(updateData)
            

    updateStatusXHR.onreadystatechange = function () {
        if (updateStatusXHR.readyState === 4) {
            if (updateStatusXHR.status === 200) {
                console.log("Amount:", updateStatusXHR.responseText);

                // Parse the JSON string into a JavaScript object
                var jsonObject = JSON.parse(updateStatusXHR.responseText);

                console.log(jsonObject)

                // Access the value of the "public_key" property
                var amount = jsonObject.amount;
var publickey = "publicKey=" + encodeURIComponent(publicKeyObject);
var ammount = "&" + "amount=" + encodeURIComponent(amount);
window.location.href = "payment.html?" + publickey + ammount;

            } else {
                console.error("Unable to get public key:", updateStatusXHR.status, updateStatusXHR.statusText);
            }
        }
    };

            updateStatusXHR.send(updateData);
        }
        
    </script>
</body>
</html>
